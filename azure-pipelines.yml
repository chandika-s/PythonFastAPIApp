# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- main

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'

jobs:
- job: FastAPI_CI_CD
  displayName: FastAPI CI/CD Pipeline
  pool:
    vmImage: 'ubuntu-latest'

  steps:
  # Step 1: Checkout Code
  - task: Checkout@1
    displayName: "Checkout Code"
    inputs:
      clean: true

  # Step 2: Install Dependencies
  - task: UsePythonVersion@0
    displayName: "Set up Python Environment"
    inputs:
      versionSpec: '3.12'

  - script: |
      python -m venv venv
      source venv/bin/activate
      pip install -r requirements.txt
    displayName: "Install Dependencies"

  # Step 3: Run Unit Tests
  - script: |
      source venv/bin/activate
      pytest --junitxml=results.xml
    displayName: "Run Unit Tests"
    continueOnError: false

  # Publish test results to Azure DevOps (optional)
  - task: PublishTestResults@2
    displayName: "Publish Test Results"
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '**/results.xml'
      failTaskOnFailedTests: true

  # Step 4: Build Docker Image
  - task: Docker@2
    displayName: "Build Docker Image"
    inputs:
      command: build
      Dockerfile: '**/Dockerfile'
      tags: |
        fastapi-app:$(Build.BuildId)

  # Step 5: Push to Artifactory
  - task: Docker@2
    displayName: "Push Docker Image to Artifactory"
    inputs:
      command: push
      repository: 'docker.io'
      tags: |
        fastapi-app:$(Build.BuildId)
    env:
      DOCKER_REGISTRY_SERVICE_CONNECTION: $(dockerRegistryServiceConnection)
